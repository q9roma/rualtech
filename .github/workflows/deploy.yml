name: Deploy to Production

on:
  # push:
  #   branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create deployment archive
      run: |
        # –°–æ–∑–¥–∞—ë–º –∞—Ä—Ö–∏–≤ —Å –∫–æ–¥–æ–º (–∏—Å–∫–ª—é—á–∞—è .git –∏ –¥—Ä—É–≥–∏–µ –Ω–µ–Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã)
        tar -czf ../deploy.tar.gz \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.env*' \
          --exclude='*.log' \
          --exclude='storage/logs/*' \
          --exclude='bootstrap/cache/*' \
          --exclude='deploy.tar.gz' \
          .
        mv ../deploy.tar.gz ./deploy.tar.gz
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "üöÄ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–µ–ø–ª–æ–π..."
          cd /var/www/www-root/data/www/rualtech.ru
          echo "üìÇ –í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞: $(pwd)"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
          echo "ÔøΩ –°–æ—Ö—Ä–∞–Ω—è–µ–º .env —Ñ–∞–π–ª..."
          cp .env /tmp/env_backup 2>/dev/null || echo "No .env to backup"
          
          echo "üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã (–∫—Ä–æ–º–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö)..."
          find . -maxdepth 1 -type f -name "*.php" -delete
          find . -maxdepth 1 -type f -name "*.md" -delete
          find . -maxdepth 1 -type f -name "*.json" -delete
          find . -maxdepth 1 -type f -name "*.js" -delete
          find . -maxdepth 1 -type f -name "*.yml" -delete
          rm -rf app/ resources/ routes/ database/ config/ bootstrap/app.php bootstrap/providers.php 2>/dev/null
          
          echo "‚úÖ –ì–æ—Ç–æ–≤ –∫ –ø–æ–ª—É—á–µ–Ω–∏—é –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤"
    
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "deploy.tar.gz"
        target: "/tmp/"
    
    - name: Extract and finalize deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "ÔøΩ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥..."
          cd /var/www/www-root/data/www/rualtech.ru
          
          if [ -f /tmp/deploy.tar.gz ]; then
            tar -xzf /tmp/deploy.tar.gz
            echo "‚úÖ –ö–æ–¥ —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω"
            
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π .env –∏–∑ .env.production
            echo "üîÑ –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π .env..."
            if [ -f ".env.production" ]; then
              cp .env.production .env
              echo "‚úÖ .env —Å–æ–∑–¥–∞–Ω –∏–∑ .env.production"
            else
              echo "‚ùå .env.production –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º .env –≤—Ä—É—á–Ω—É—é"
              cat > .env << 'ENVEOF'
          APP_NAME=Laravel
          APP_ENV=production
          APP_KEY=base64:koCcDULFl7i77qQI2uVkvcZ2613SXNC8R1mCahDmveU=
          APP_DEBUG=false
          APP_URL=https://rualtech.ru
          
          APP_LOCALE=ru
          APP_FALLBACK_LOCALE=ru
          
          DB_CONNECTION=mysql
          DB_HOST=localhost
          DB_PORT=3306
          DB_DATABASE=rualtech
          DB_USERNAME=alexsor
          DB_PASSWORD=eY7rG4pX7r
          
          SESSION_DRIVER=file
          SESSION_LIFETIME=120
          
          CACHE_STORE=file
          QUEUE_CONNECTION=database
          
          MAIL_MAILER=log
          MAIL_FROM_ADDRESS="office@rualtech.ru"
          MAIL_FROM_NAME="–ê–ª—Ç–µ—Ö"
          ENVEOF
            fi
            
            # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
            rm -f /tmp/deploy.tar.gz /tmp/env_backup
          else
            echo "‚ùå –ê—Ä—Ö–∏–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            exit 1
          fi
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
          grep -n "–ê–ª—Ç–µ—Ö\|Altech" resources/views/frontend/home.blade.php || echo "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à–∏ Laravel..."
          php artisan cache:clear 2>/dev/null || echo "Cache clear failed"
          php artisan view:clear 2>/dev/null || echo "View clear failed"  
          php artisan config:clear 2>/dev/null || echo "Config clear failed"
          
          echo "ÔøΩ –°–æ–∑–¥–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞..."
          php artisan admin:create "alexsoroka" "corp-altekh07938@yandex.ru" "admin123!" 2>/dev/null || echo "Admin user already exists or creation failed"
          
          echo "ÔøΩüîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä..."
          systemctl reload nginx 2>/dev/null || echo "Nginx reload failed"
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ https://rualtech.ru"
          echo "üîê –ê–¥–º–∏–Ω–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É: https://rualtech.ru/admin/login"
