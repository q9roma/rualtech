name: Deploy to Production

on:
  # push:
  #   branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create deployment archive
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð°Ñ€Ñ…Ð¸Ð² Ñ ÐºÐ¾Ð´Ð¾Ð¼ (Ð¸ÑÐºÐ»ÑŽÑ‡Ð°Ñ .git Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð½ÐµÐ½ÑƒÐ¶Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹)
        tar -czf ../deploy.tar.gz \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.env*' \
          --exclude='*.log' \
          --exclude='storage/logs/*' \
          --exclude='bootstrap/cache/*' \
          --exclude='deploy.tar.gz' \
          .
        mv ../deploy.tar.gz ./deploy.tar.gz
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "ðŸš€ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹..."
          cd /var/www/www-root/data/www/rualtech.ru
          echo "ðŸ“‚ Ð’ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°: $(pwd)"
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²Ð°Ð¶Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          echo "ï¿½ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ .env Ñ„Ð°Ð¹Ð»..."
          cp .env /tmp/env_backup 2>/dev/null || echo "No .env to backup"
          
          echo "ðŸ§¹ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ (ÐºÑ€Ð¾Ð¼Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ñ…)..."
          find . -maxdepth 1 -type f -name "*.php" -delete
          find . -maxdepth 1 -type f -name "*.md" -delete
          find . -maxdepth 1 -type f -name "*.json" -delete
          find . -maxdepth 1 -type f -name "*.js" -delete
          find . -maxdepth 1 -type f -name "*.yml" -delete
          rm -rf app/ resources/ routes/ database/ config/ bootstrap/app.php bootstrap/providers.php 2>/dev/null
          
          echo "âœ… Ð“Ð¾Ñ‚Ð¾Ð² Ðº Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸ÑŽ Ð½Ð¾Ð²Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²"
    
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "deploy.tar.gz"
        target: "/tmp/"
    
    - name: Extract and finalize deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "ï¿½ Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð´..."
          cd /var/www/www-root/data/www/rualtech.ru
          
          if [ -f /tmp/deploy.tar.gz ]; then
            tar -xzf /tmp/deploy.tar.gz
            echo "âœ… ÐšÐ¾Ð´ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ð°Ð½"
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ .env Ð¸Ð· .env.production
            echo "ðŸ”„ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ .env..."
            if [ -f ".env.production" ]; then
              cp .env.production .env
              echo "âœ… .env ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸Ð· .env.production"
            else
              echo "âŒ .env.production Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ .env Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ"
              cat > .env << 'ENVEOF'
          APP_NAME=Laravel
          APP_ENV=production
          APP_KEY=base64:koCcDULFl7i77qQI2uVkvcZ2613SXNC8R1mCahDmveU=
          APP_DEBUG=false
          APP_URL=https://rualtech.ru
          
          APP_LOCALE=ru
          APP_FALLBACK_LOCALE=ru
          
          DB_CONNECTION=mysql
          DB_HOST=localhost
          DB_PORT=3306
          DB_DATABASE=rualtech
          DB_USERNAME=alexsor
          DB_PASSWORD=eY7rG4pX7r
          
          SESSION_DRIVER=file
          SESSION_LIFETIME=120
          
          CACHE_STORE=file
          QUEUE_CONNECTION=database
          
          MAIL_MAILER=log
          MAIL_FROM_ADDRESS="office@rualtech.ru"
          MAIL_FROM_NAME="ÐÐ»Ñ‚ÐµÑ…"
          ENVEOF
            fi
            
            # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
            rm -f /tmp/deploy.tar.gz /tmp/env_backup
          else
            echo "âŒ ÐÑ€Ñ…Ð¸Ð² Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
            exit 1
          fi
          
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ:"
          grep -n "ÐÐ»Ñ‚ÐµÑ…\|Altech" resources/views/frontend/home.blade.php || echo "Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          
          echo "ðŸ§¹ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÑÑˆÐ¸ Laravel..."
          php artisan cache:clear 2>/dev/null || echo "Cache clear failed"
          php artisan view:clear 2>/dev/null || echo "View clear failed"  
          php artisan config:clear 2>/dev/null || echo "Config clear failed"
          
          echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð²ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€..."
          systemctl reload nginx 2>/dev/null || echo "Nginx reload failed"
          
          echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½! ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ https://rualtech.ru"
