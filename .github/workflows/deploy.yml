name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–µ–ø–ª–æ—è"
          echo "üìÇ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:"
          pwd
          
          cd /var/www/www-root/data/www/rualtech.ru
          echo "üìÇ –ü–µ—Ä–µ—à–ª–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞:"
          pwd
          
          echo "üìä –°—Ç–∞—Ç—É—Å Git –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º:"
          git status || echo "Git status failed"
          
          echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç:"
          git log --oneline -1 || echo "Git log failed"
          
          # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è Git
          echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ Git..."
          git config --global --add safe.directory /var/www/www-root/data/www/rualtech.ru
          git config --global --add safe.directory '*'
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          echo "üì• –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ GitHub..."
          git remote set-url origin https://github.com/q9roma/rualtech.git
          git fetch origin main --force 2>/dev/null || echo "Fetch —á–µ—Ä–µ–∑ HTTPS failed, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–±..."
          
          # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - —Å–∫–∞—á–∏–≤–∞–µ–º –∞—Ä—Ö–∏–≤ –Ω–∞–ø—Ä—è–º—É—é
          if ! git diff --quiet HEAD origin/main 2>/dev/null; then
            echo "ÔøΩ –°–∫–∞—á–∏–≤–∞–µ–º —Å–≤–µ–∂–∏–π –∫–æ–¥ —á–µ—Ä–µ–∑ wget..."
            wget -O /tmp/latest.zip https://github.com/q9roma/rualtech/archive/refs/heads/main.zip
            if [ -f /tmp/latest.zip ]; then
              # –°–æ–∑–¥–∞—ë–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–∏—Ö —Ñ–∞–π–ª–æ–≤
              cp -r . /tmp/backup_site/
              # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥
              unzip -o /tmp/latest.zip -d /tmp/
              cp -r /tmp/rualtech-main/* .
              rm -f /tmp/latest.zip
              rm -rf /tmp/rualtech-main/
              echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω —á–µ—Ä–µ–∑ –∞—Ä—Ö–∏–≤"
            fi
          fi
          
          echo "ÔøΩüîÑ –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞..."
          git reset --hard origin/main 2>/dev/null || echo "Reset failed, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
          git clean -fd 2>/dev/null || echo "Clean failed, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
          
          echo "üìä –°—Ç–∞—Ç—É—Å Git –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
          git status || echo "Git status failed"
          
          echo "üìã –ö–æ–º–º–∏—Ç –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
          git log --oneline -1 || echo "Git log failed"
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ home.blade.php:"
          if [ -f "resources/views/frontend/home.blade.php" ]; then
            grep -n "–ê–ª—Ç–µ—Ö\|Altech" resources/views/frontend/home.blade.php || echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ Altech, –Ω–∏ –ê–ª—Ç–µ—Ö"
          else
            echo "‚ùå –§–∞–π–ª home.blade.php –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          fi
          
          # –û—á–∏—â–∞–µ–º –∫—ç—à–∏
          echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à–∏ Laravel..."
          php artisan cache:clear 2>/dev/null || echo "Cache clear failed"
          php artisan view:clear 2>/dev/null || echo "View clear failed"
          php artisan config:clear 2>/dev/null || echo "Config clear failed"
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä..."
          systemctl reload nginx 2>/dev/null || echo "Nginx reload failed"
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç."
