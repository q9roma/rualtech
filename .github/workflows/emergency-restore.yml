name: Emergency Site Restore

on:
  workflow_dispatch:

jobs:
  restore:
    runs-on: ubuntu-latest
    
    steps:
    - name: Emergency restore
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "üö® –≠–ö–°–¢–†–ï–ù–ù–û–ï –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ê–ô–¢–ê"
          cd /var/www/www-root/data/www/rualtech.ru
          
          # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ —Ñ–∞–π–ª—ã
          echo "üìÅ –°–æ–∑–¥–∞—ë–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
          mkdir -p storage/logs
          mkdir -p storage/framework/cache/data
          mkdir -p storage/framework/sessions
          mkdir -p storage/framework/views
          mkdir -p storage/app/public
          mkdir -p bootstrap/cache
          
          # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
          echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
          chown -R www-data:www-data storage bootstrap/cache
          chmod -R 775 storage bootstrap/cache
          
          # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º storage –µ—Å–ª–∏ –µ—Å—Ç—å –±—ç–∫–∞–ø
          if [ -d /tmp/storage_backup ]; then
            echo "üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º storage –∏–∑ –±—ç–∫–∞–ø–∞..."
            cp -r /tmp/storage_backup/* storage/
            chown -R www-data:www-data storage
          fi
          
          # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º bootstrap/cache –µ—Å–ª–∏ –µ—Å—Ç—å –±—ç–∫–∞–ø
          if [ -d /tmp/bootstrap_cache_backup ]; then
            echo "üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º bootstrap/cache –∏–∑ –±—ç–∫–∞–ø–∞..."
            cp -r /tmp/bootstrap_cache_backup/* bootstrap/cache/
            chown -R www-data:www-data bootstrap/cache
          fi
          
          # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .env
          if [ -f /tmp/env_backup ]; then
            echo "‚öôÔ∏è –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .env..."
            cp /tmp/env_backup .env
          fi
          
          # –°–æ–∑–¥–∞—ë–º –±–∞–∑–æ–≤—ã–π .env –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if [ ! -f .env ]; then
            echo "‚öôÔ∏è –°–æ–∑–¥–∞—ë–º –±–∞–∑–æ–≤—ã–π .env —Ñ–∞–π–ª..."
            cat > .env << 'EOF'
APP_NAME=Altech
APP_ENV=production
APP_KEY=base64:your_app_key_here
APP_DEBUG=false
APP_URL=https://rualtech.ru

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=your_database
DB_USERNAME=your_username
DB_PASSWORD=your_password
EOF
          fi
          
          # –û—á–∏—â–∞–µ–º –∫—ç—à–∏
          echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à–∏..."
          php artisan cache:clear 2>/dev/null || echo "Cache clear failed"
          php artisan config:clear 2>/dev/null || echo "Config clear failed"
          php artisan view:clear 2>/dev/null || echo "View clear failed"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑—á–∏–∫
          echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑—á–∏–∫..."
          composer dump-autoload 2>/dev/null || echo "Composer dump-autoload failed"
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä..."
          systemctl reload nginx
          systemctl reload apache2 2>/dev/null || echo "Apache reload failed"
          
          echo "‚úÖ –≠–ö–°–¢–†–ï–ù–ù–û–ï –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
          echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: https://rualtech.ru"
