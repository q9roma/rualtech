name: Fix Permissions

on:
  workflow_dispatch:

jobs:
  fix-permissions:
    runs-on: ubuntu-latest
    
    steps:
    - name: Fix Laravel Permissions
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ Laravel..."
          cd /var/www/www-root/data/www/rualtech.ru
          
          echo "üìÅ –°–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–∞–ø–∫–∏:"
          mkdir -p storage/framework/cache/data
          mkdir -p storage/framework/sessions
          mkdir -p storage/framework/views
          mkdir -p storage/logs
          mkdir -p bootstrap/cache
          
          echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:"
          chmod -R 775 storage
          chmod -R 775 bootstrap/cache
          chown -R www-data:www-data storage
          chown -R www-data:www-data bootstrap/cache
          
          echo "üßπ –û—á–∏—â–∞–µ–º –≤—Å–µ –∫–µ—à–∏:"
          php artisan config:clear 2>/dev/null || echo "Config clear failed"
          php artisan cache:clear 2>/dev/null || echo "Cache clear failed"  
          php artisan view:clear 2>/dev/null || echo "View clear failed"
          php artisan route:clear 2>/dev/null || echo "Route clear failed"
          
          echo "üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
          php artisan key:generate --force 2>/dev/null || echo "Key generate failed"
          
          echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç:"
          ls -la storage/
          ls -la bootstrap/cache/
          
          echo ""
          echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∑–∞–π—Ç–∏ –≤ –∞–¥–º–∏–Ω–∫—É:"
          echo "üîó https://rualtech.ru/admin/login"
