name: Debug Server Issues

on:
  workflow_dispatch:
    inputs:
      debug_level:
        description: 'Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ¸'
        required: false
        default: 'full'

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H rualtech.ru >> ~/.ssh/known_hosts
        
    - name: Full server diagnostics
      run: |
        ssh root@rualtech.ru << 'EOF'
        cd /var/www/rualtech.ru/
        
        echo "ðŸ” === Ð”Ð˜ÐÐ“ÐÐžÐ¡Ð¢Ð˜ÐšÐ Ð¡Ð•Ð Ð’Ð•Ð Ð ==="
        echo
        
        echo "ðŸ“ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°:"
        ls -la
        echo
        
        echo "ðŸ“‹ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ .env Ñ„Ð°Ð¹Ð»Ð°:"
        if [ -f ".env" ]; then
          cat .env
        else
          echo "âŒ .env Ñ„Ð°Ð¹Ð» Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚!"
        fi
        echo
        
        echo "ðŸ”‘ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° APP_KEY:"
        grep "APP_KEY" .env || echo "âŒ APP_KEY Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        echo
        
        echo "ðŸ—„ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…:"
        mysql -u root -e "SHOW DATABASES;" | grep -E "(altech|rualtech)" || echo "âŒ Ð‘Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
        echo
        
        echo "ðŸ“ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Laravel (storage/logs):"
        if [ -d "storage/logs" ]; then
          ls -la storage/logs/
          echo "--- ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 20 ÑÑ‚Ñ€Ð¾Ðº Ð¸Ð· laravel.log ---"
          tail -20 storage/logs/laravel.log 2>/dev/null || echo "Ð›Ð¾Ð³ Ñ„Ð°Ð¹Ð» Ð¿ÑƒÑÑ‚ Ð¸Ð»Ð¸ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
        else
          echo "âŒ ÐŸÐ°Ð¿ÐºÐ° storage/logs Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
        fi
        echo
        
        echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°:"
        echo "storage/:"
        ls -la storage/ | head -5
        echo "bootstrap/cache/:"
        ls -la bootstrap/cache/ | head -5
        echo
        
        echo "ðŸ˜ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° PHP:"
        php -v
        echo
        
        echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Composer:"
        composer --version
        echo "vendor/autoload.php:"
        ls -la vendor/autoload.php || echo "âŒ vendor/autoload.php Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
        echo
        
        echo "ðŸŒ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€Ð°:"
        systemctl status apache2 | head -10
        echo
        
        echo "ðŸ” ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° artisan:"
        php artisan --version || echo "âŒ Artisan Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
        echo
        
        echo "ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²ÑÐµÑ… ÐºÐµÑˆÐµÐ¹:"
        php artisan config:clear
        php artisan cache:clear
        php artisan route:clear
        php artisan view:clear
        php artisan optimize:clear
        
        echo
        echo "âœ… Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
        EOF
        
    - name: Test site response with details
      run: |
        echo "ðŸŒ ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ñ‚Ð²ÐµÑ‚Ð° ÑÐ°Ð¹Ñ‚Ð°:"
        
        echo "1. ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ:"
        curl -I https://rualtech.ru/ 2>/dev/null || echo "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ"
        
        echo "2. Ð—Ð°Ð¿Ñ€Ð¾Ñ Ñ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸:"
        curl -v https://rualtech.ru/ 2>&1 | head -20
        
        echo "3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÐºÐ¾Ð´Ð°:"
        status=$(curl -s -o /dev/null -w "%{http_code}" https://rualtech.ru/ 2>/dev/null || echo "error")
        echo "HTTP Status: $status"
