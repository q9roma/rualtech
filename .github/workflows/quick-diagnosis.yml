name: Quick Server Diagnosis

on:
  workflow_dispatch:

jobs:
  diagnose:
    runs-on: ubuntu-latest
    
    steps:
    - name: Quick server check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "üîç === –ë–´–°–¢–†–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ==="
          
          echo "üìÇ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:"
          pwd
          
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–æ–µ–∫—Ç–∞:"
          cd /var/www/www-root/data/www/rualtech.ru/
          pwd
          ls -la
          
          echo "üìã –°—Ç–∞—Ç—É—Å .env —Ñ–∞–π–ª–∞:"
          if [ -f ".env" ]; then
            echo "‚úÖ .env –Ω–∞–π–¥–µ–Ω"
            echo "--- –ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ .env ---"
            head -10 .env
            echo "--- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î ---"
            grep "DB_" .env
          else
            echo "‚ùå .env –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
          fi
          
          echo "üîß –¢–µ—Å—Ç artisan:"
          php artisan --version || echo "‚ùå Artisan –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
          
          echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ Laravel:"
          if [ -f "storage/logs/laravel.log" ]; then
            echo "--- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ ---"
            tail -10 storage/logs/laravel.log
          else
            echo "‚ùå –õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
          fi
          
          echo "üóÑÔ∏è –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î:"
          php artisan tinker --execute="echo 'DB test: '; try { DB::connection()->getPdo(); echo 'DB OK'; } catch(Exception \$e) { echo 'DB Error: '.\$e->getMessage(); }" || echo "‚ùå Tinker –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
