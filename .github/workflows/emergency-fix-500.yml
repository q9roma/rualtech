name: Emergency Fix 500

on:
  workflow_dispatch:

jobs:
  emergency-fix:
    runs-on: ubuntu-latest
    
    steps:
    - name: Emergency Fix 500 Error
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "ğŸš¨ Ğ­ĞšĞ¡Ğ¢Ğ Ğ•ĞĞĞĞ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• 500 ĞĞ¨Ğ˜Ğ‘ĞšĞ˜..."
          cd /var/www/www-root/data/www/rualtech.ru
          
          # 1. Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ½Ñ‹Ğ¹ helper Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ
          echo "ğŸ”§ ĞÑ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ helper..."
          cp app/Providers/AppServiceProvider.php app/Providers/AppServiceProvider.php.backup
          
          cat > app/Providers/AppServiceProvider.php << 'PHPEOF'
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;
use Illuminate\Support\Facades\URL;
use Carbon\Carbon;

class AppServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        //
    }

    public function boot(): void
    {
        // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ€ÑƒÑÑĞºÑƒÑ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒ Ğ´Ğ»Ñ Carbon
        Carbon::setLocale('ru');
        setlocale(LC_TIME, 'ru_RU.UTF-8');
        
        // ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ HTTPS Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğ°
        if (config('app.env') === 'production') {
            URL::forceScheme('https');
        }
    }
}
PHPEOF
          
          # 2. Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ view Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ¾Ğ¹ ÑĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ñ
          echo "ğŸ”§ Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ğ² views..."
          sed -i 's/services_count_text(\$count)/(\$count > 0 ? \$count . " ÑƒÑĞ»ÑƒĞ³" : "")/g' resources/views/frontend/home.blade.php
          
          # 3. ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²ÑĞµ ĞºĞµÑˆĞ¸
          echo "ğŸ§¹ ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²ÑĞµ ĞºĞµÑˆĞ¸..."
          php artisan config:clear --no-interaction 2>/dev/null
          php artisan cache:clear --no-interaction 2>/dev/null
          php artisan view:clear --no-interaction 2>/dev/null
          php artisan route:clear --no-interaction 2>/dev/null
          
          # 4. Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ autoload Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾
          echo "ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ autoload..."
          composer dump-autoload --no-interaction 2>/dev/null || echo "Composer Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
          
          # 5. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
          echo "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ°..."
          chmod -R 775 storage bootstrap/cache 2>/dev/null
          chown -R www-data:www-data storage bootstrap/cache 2>/dev/null || echo "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ°"
          
          # 6. Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ°Ğ¹Ñ‚
          echo "ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ°Ğ¹Ñ‚..."
          curl -I https://rualtech.ru/ 2>/dev/null | head -1 || echo "Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°"
          curl -I https://rualtech.ru/admin/login 2>/dev/null | head -1 || echo "ĞĞ´Ğ¼Ğ¸Ğ½ĞºĞ° Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°"
          
          echo ""
          echo "âœ… Ğ­ĞšĞ¡Ğ¢Ğ Ğ•ĞĞĞĞ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ!"
          echo "ğŸŒ Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ: https://rualtech.ru/"
          echo "ğŸ” ĞĞ´Ğ¼Ğ¸Ğ½ĞºĞ°: https://rualtech.ru/admin/login"
          echo "ğŸ“§ Email: corp-altekh07938@yandex.ru"
          echo "ğŸ”‘ Password: admin123!"
