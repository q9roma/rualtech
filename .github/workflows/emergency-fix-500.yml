name: Emergency Fix 500

on:
  workflow_dispatch:

jobs:
  emergency-fix:
    runs-on: ubuntu-latest
    
    steps:
    - name: Emergency Fix 500 Error
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "🚨 ЭКСТРЕННОЕ ИСПРАВЛЕНИЕ 500 ОШИБКИ..."
          cd /var/www/www-root/data/www/rualtech.ru
          
          # 1. Временно отключаем проблемный helper полностью
          echo "🔧 Отключаем helper..."
          cp app/Providers/AppServiceProvider.php app/Providers/AppServiceProvider.php.backup
          
          cat > app/Providers/AppServiceProvider.php << 'PHPEOF'
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;
use Illuminate\Support\Facades\URL;
use Carbon\Carbon;

class AppServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        //
    }

    public function boot(): void
    {
        // Устанавливаем русскую локаль для Carbon
        Carbon::setLocale('ru');
        setlocale(LC_TIME, 'ru_RU.UTF-8');
        
        // Принудительно используем HTTPS только для продакшена
        if (config('app.env') === 'production') {
            URL::forceScheme('https');
        }
    }
}
PHPEOF
          
          # 2. Исправляем view с проблемой склонения
          echo "🔧 Исправляем проблемы в views..."
          sed -i 's/services_count_text(\$count)/(\$count > 0 ? \$count . " услуг" : "")/g' resources/views/frontend/home.blade.php
          
          # 3. Очищаем все кеши
          echo "🧹 Очищаем все кеши..."
          php artisan config:clear --no-interaction 2>/dev/null
          php artisan cache:clear --no-interaction 2>/dev/null
          php artisan view:clear --no-interaction 2>/dev/null
          php artisan route:clear --no-interaction 2>/dev/null
          
          # 4. Генерируем autoload заново
          echo "🔄 Обновляем autoload..."
          composer dump-autoload --no-interaction 2>/dev/null || echo "Composer не найден"
          
          # 5. Проверяем права доступа
          echo "🔐 Проверяем права..."
          chmod -R 775 storage bootstrap/cache 2>/dev/null
          chown -R www-data:www-data storage bootstrap/cache 2>/dev/null || echo "Не удалось изменить владельца"
          
          # 6. Тестируем сайт
          echo "🧪 Тестируем сайт..."
          curl -I https://rualtech.ru/ 2>/dev/null | head -1 || echo "Главная недоступна"
          curl -I https://rualtech.ru/admin/login 2>/dev/null | head -1 || echo "Админка недоступна"
          
          echo ""
          echo "✅ ЭКСТРЕННОЕ ИСПРАВЛЕНИЕ ЗАВЕРШЕНО!"
          echo "🌐 Главная: https://rualtech.ru/"
          echo "🔐 Админка: https://rualtech.ru/admin/login"
          echo "📧 Email: corp-altekh07938@yandex.ru"
          echo "🔑 Password: admin123!"
