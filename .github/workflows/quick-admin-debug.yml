name: Emergency Site Diagnosis

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Emergency Site Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "=== ÔøΩ –ü–û–ò–°–ö –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï NGINX –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ==="
            
            echo -e "\n=== –®–ê–ì 1: –ò—â–µ–º –∫–æ–Ω—Ñ–∏–≥ —Ñ–∞–π–ª—ã nginx ==="
            find /etc -name "*nginx*" -type d 2>/dev/null | head -10
            find /var -name "*nginx*" -type d 2>/dev/null | head -10
            
            echo -e "\n=== –®–ê–ì 2: –ò—â–µ–º –∫–æ–Ω—Ñ–∏–≥–∏ –¥–ª—è rualtech.ru ==="
            find /etc -name "*rualtech*" 2>/dev/null
            find /var -name "*rualtech*" 2>/dev/null
            
            echo -e "\n=== –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—É—Ç–∏ ==="
            ls -la /etc/nginx/ 2>/dev/null || echo "‚ùå /etc/nginx/ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            ls -la /etc/nginx/sites-available/ 2>/dev/null || echo "‚ùå /etc/nginx/sites-available/ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            ls -la /etc/nginx/conf.d/ 2>/dev/null || echo "‚ùå /etc/nginx/conf.d/ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            ls -la /etc/nginx/vhosts/ 2>/dev/null || echo "‚ùå /etc/nginx/vhosts/ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            
            echo -e "\n=== –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä—è–µ–º /var –ø—É—Ç–∏ ==="
            ls -la /var/www/httpd-conf/ 2>/dev/null || echo "‚ùå /var/www/httpd-conf/ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            ls -la /var/www/nginx-conf/ 2>/dev/null || echo "‚ùå /var/www/nginx-conf/ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            
            echo -e "\n=== –®–ê–ì 5: –ò—â–µ–º –≤—Å–µ .conf —Ñ–∞–π–ª—ã —Å nginx ==="
            find /etc /var -name "*.conf" -exec grep -l "rualtech.ru\|server_name" {} \; 2>/dev/null | head -5
            
            echo -e "\n=== –®–ê–ì 6: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å nginx ==="
            ps aux | grep nginx | grep -v grep
            
            echo -e "\n=== –®–ê–ì 7: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥ nginx ==="
            nginx -t 2>&1
            
            echo -e "\n=== –®–ê–ì 8: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ ==="
            nginx -T 2>/dev/null | grep -A 10 -B 5 "rualtech.ru" || echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –≤ –≥–ª–∞–≤–Ω–æ–º –∫–æ–Ω—Ñ–∏–≥–µ"
            
            echo -e "\n=== –®–ê–ì 9: –ò—â–µ–º include –¥–∏—Ä–µ–∫—Ç–∏–≤—ã ==="
            grep -r "include.*conf" /etc/nginx/ 2>/dev/null | head -5
            
            echo -e "\n=== üìç –†–ï–ó–£–õ–¨–¢–ê–¢ –ü–û–ò–°–ö–ê –ó–ê–í–ï–†–®–ï–ù ===" Debug

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Final Admin Test
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            cd /var/www/www-root/data/www/rualtech.ru
            
            echo "=== ‚úÖ Filament –∞—Å—Å–µ—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç ==="
            echo "JS: $(curl -s -o /dev/null -w "%{http_code}" https://rualtech.ru/vendor/filament/index.js)"
            echo "CSS: $(curl -s -o /dev/null -w "%{http_code}" https://rualtech.ru/vendor/filament/theme.css)"
            
            echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ==="
            php artisan tinker --execute="
            \$user = App\\Models\\User::where('email', 'corp-altekh07938@yandex.ru')->first();
            echo 'User: ' . \$user->email . ' (ID: ' . \$user->id . ')';
            "
            
            echo -e "\n=== –¢–µ—Å—Ç –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ ==="
            curl -I https://rualtech.ru/admin/login | head -3
            
            echo -e "\n=== üéâ –ì–û–¢–û–í–û! –ê–¥–º–∏–Ω–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ ==="
            echo "üîó URL: https://rualtech.ru/admin/login"
            echo "üìß Email: corp-altekh07938@yandex.ru"
            echo "üîë Password: altechcorp2024"
            echo ""
            echo "‚úÖ Filament –∞—Å—Å–µ—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è"
            echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω"
            echo "‚úÖ HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç"
            echo ""
            echo "üîÑ –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+Shift+Del) –∏ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω–∫—É!"