name: Emergency Site Diagnosis

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Emergency Site Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "=== üö® –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ê–ô–¢–ê ==="
            
            echo -e "\n=== –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: Apache/Nginx –∫–æ–Ω—Ñ–ª–∏–∫—Ç ==="
            echo "–°–∞–π—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —á–µ—Ä–µ–∑ Apache –≤–º–µ—Å—Ç–æ Nginx!"
            
            echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –ø–æ—Ä—Ç–æ–≤ ==="
            netstat -tlnp | grep :80
            netstat -tlnp | grep :443
            
            echo -e "\n=== –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤ ==="
            systemctl status apache2 --no-pager -l
            echo "--- NGINX STATUS ---"
            systemctl status nginx --no-pager -l
            
            echo -e "\n=== –≠–ö–°–¢–†–ï–ù–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ù–§–õ–ò–ö–¢–ê ==="
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Apache (–æ–Ω –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ä—Ç—ã)
            echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Apache..."
            systemctl stop apache2
            systemctl disable apache2
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤
            sleep 3
            echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤..."
            netstat -tlnp | grep :80 || echo "‚úÖ –ü–æ—Ä—Ç 80 –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω"
            netstat -tlnp | grep :443 || echo "‚úÖ –ü–æ—Ä—Ç 443 –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω"
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º Nginx —Å SSL
            echo "–ó–∞–ø—É—Å–∫–∞–µ–º Nginx..."
            systemctl enable nginx
            systemctl start nginx
            systemctl reload nginx
            
            echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ==="
            systemctl status nginx --no-pager -l
            
            echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º HTTP..."
            curl -I http://localhost 2>&1 | head -3
            
            echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º HTTPS..."
            curl -I https://localhost 2>&1 | head -3
            
            echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ ==="
            curl -I http://rualtech.ru 2>&1 | head -3
            curl -I https://rualtech.ru 2>&1 | head -3
            
            echo -e "\n=== ‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===" Debug

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Final Admin Test
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            cd /var/www/www-root/data/www/rualtech.ru
            
            echo "=== ‚úÖ Filament –∞—Å—Å–µ—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç ==="
            echo "JS: $(curl -s -o /dev/null -w "%{http_code}" https://rualtech.ru/vendor/filament/index.js)"
            echo "CSS: $(curl -s -o /dev/null -w "%{http_code}" https://rualtech.ru/vendor/filament/theme.css)"
            
            echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ==="
            php artisan tinker --execute="
            \$user = App\\Models\\User::where('email', 'corp-altekh07938@yandex.ru')->first();
            echo 'User: ' . \$user->email . ' (ID: ' . \$user->id . ')';
            "
            
            echo -e "\n=== –¢–µ—Å—Ç –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ ==="
            curl -I https://rualtech.ru/admin/login | head -3
            
            echo -e "\n=== üéâ –ì–û–¢–û–í–û! –ê–¥–º–∏–Ω–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ ==="
            echo "üîó URL: https://rualtech.ru/admin/login"
            echo "üìß Email: corp-altekh07938@yandex.ru"
            echo "üîë Password: altechcorp2024"
            echo ""
            echo "‚úÖ Filament –∞—Å—Å–µ—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è"
            echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω"
            echo "‚úÖ HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç"
            echo ""
            echo "üîÑ –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+Shift+Del) –∏ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω–∫—É!"