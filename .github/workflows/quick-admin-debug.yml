name: Emergency Site Diagnosis

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Emergency Site Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "=== üö® –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ê–ô–¢–ê ==="
            
            echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞ ==="
            curl -I http://rualtech.ru/ 2>&1 | head -3
            curl -I https://rualtech.ru/ 2>&1 | head -3
            
            echo -e "\n=== –°—Ç–∞—Ç—É—Å –≤–µ–±-—Å–µ—Ä–≤–∏—Å–æ–≤ ==="
            systemctl status nginx | head -10
            systemctl status apache2 | head -10
            systemctl status php8.3-fpm | head -10
            
            echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ ==="
            openssl x509 -in /var/www/httpd-cert/www-root/www.rualtech.ru_custom_1.crtca -text -noout | grep -A 2 "Validity" || echo "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
            
            echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ==="
            nginx -t
            
            echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º ==="
            ls -la /var/www/www-root/data/www/rualtech.ru/ | head -5
            
            echo -e "\n=== –õ–æ–≥–∏ nginx (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏) ==="
            tail -20 /var/log/nginx/error.log | grep -E "(error|403|ssl)" || echo "–ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫"
            
            echo -e "\n=== –õ–æ–≥–∏ nginx access (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã) ==="
            tail -10 /var/www/httpd-logs/rualtech.ru.access.log | grep -E "(403|404|500)" || echo "–ù–µ—Ç –æ—à–∏–±–æ–∫ –¥–æ—Å—Ç—É–ø–∞"
            
            echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ ==="
            ls -la /var/www/www-root/data/www/rualtech.ru/public/
            
            echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ ==="
            df -h | head -5
            
            echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ ==="
            ps aux | grep -E "(nginx|apache|php)" | head -5
            
            echo -e "\n=== Laravel –ª–æ–≥–∏ ==="
            tail -10 /var/www/www-root/data/www/rualtech.ru/storage/logs/laravel.log 2>/dev/null || echo "–ù–µ—Ç Laravel –ª–æ–≥–æ–≤"
            
            echo -e "\n=== –ë—ã—Å—Ç—Ä—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ==="
            echo "1. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
            systemctl restart nginx
            systemctl restart php8.3-fpm
            
            echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞..."
            sleep 3
            curl -I https://rualtech.ru/ 2>&1 | head -3 Debug

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Final Admin Test
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            cd /var/www/www-root/data/www/rualtech.ru
            
            echo "=== ‚úÖ Filament –∞—Å—Å–µ—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç ==="
            echo "JS: $(curl -s -o /dev/null -w "%{http_code}" https://rualtech.ru/vendor/filament/index.js)"
            echo "CSS: $(curl -s -o /dev/null -w "%{http_code}" https://rualtech.ru/vendor/filament/theme.css)"
            
            echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ==="
            php artisan tinker --execute="
            \$user = App\\Models\\User::where('email', 'corp-altekh07938@yandex.ru')->first();
            echo 'User: ' . \$user->email . ' (ID: ' . \$user->id . ')';
            "
            
            echo -e "\n=== –¢–µ—Å—Ç –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ ==="
            curl -I https://rualtech.ru/admin/login | head -3
            
            echo -e "\n=== üéâ –ì–û–¢–û–í–û! –ê–¥–º–∏–Ω–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ ==="
            echo "üîó URL: https://rualtech.ru/admin/login"
            echo "üìß Email: corp-altekh07938@yandex.ru"
            echo "üîë Password: altechcorp2024"
            echo ""
            echo "‚úÖ Filament –∞—Å—Å–µ—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è"
            echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω"
            echo "‚úÖ HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç"
            echo ""
            echo "üîÑ –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+Shift+Del) –∏ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω–∫—É!"