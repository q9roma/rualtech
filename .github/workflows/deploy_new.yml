name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
          
          cd /var/www/www-root/data/www/rualtech.ru
          echo "üìÇ –í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞: $(pwd)"
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫–∞—á–∏–≤–∞–µ–º —Å–≤–µ–∂–∏–π –∫–æ–¥
          echo "üì¶ –°–∫–∞—á–∏–≤–∞–µ–º —Å–≤–µ–∂–∏–π –∫–æ–¥..."
          wget -O /tmp/latest.zip https://github.com/q9roma/rualtech/archive/refs/heads/main.zip
          
          if [ -f /tmp/latest.zip ]; then
            echo "üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º .env —Ñ–∞–π–ª..."
            cp .env /tmp/env_backup 2>/dev/null || echo "No .env to backup"
            
            echo "üìÇ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥..."
            cd /tmp
            unzip -o latest.zip
            
            echo "üìã –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–∞–π—Ç..."
            cd /var/www/www-root/data/www/rualtech.ru
            cp -r /tmp/rualtech-main/* .
            
            echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .env..."
            cp /tmp/env_backup .env 2>/dev/null || echo "No .env to restore"
            
            echo "üßπ –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
            rm -f /tmp/latest.zip
            rm -rf /tmp/rualtech-main/
            
            echo "‚úÖ –ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!"
          else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤"
            exit 1
          fi
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
          grep -n "–ê–ª—Ç–µ—Ö\|Altech" resources/views/frontend/home.blade.php || echo "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à–∏ Laravel..."
          php artisan cache:clear
          php artisan view:clear
          php artisan config:clear
          
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä..."
          systemctl reload nginx
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ https://rualtech.ru"
