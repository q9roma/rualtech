name: Fix ENV File on Server

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°'
        required: false
        default: 'Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°'

jobs:
  fix-env:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts
        
    - name: Fix .env file on server
      run: |
        ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
        cd /var/www/www-root/data/www/rualtech.ru/
        
        echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ .env Ñ„Ð°Ð¹Ð»..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ð¸Ð· .env.production
        if [ -f ".env.production" ]; then
          cp .env.production .env
          echo "âœ… .env ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸Ð· .env.production"
        else
          echo "âŒ .env.production Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ .env Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ"
          cat > .env << 'ENVEOF'
        APP_NAME=Laravel
        APP_ENV=production
        APP_KEY=base64:koCcDULFl7i77qQI2uVkvcZ2613SXNC8R1mCahDmveU=
        APP_DEBUG=false
        APP_URL=https://rualtech.ru

        APP_LOCALE=ru
        APP_FALLBACK_LOCALE=ru
        APP_FAKER_LOCALE=ru_RU

        APP_MAINTENANCE_DRIVER=file

        PHP_CLI_SERVER_WORKERS=4

        BCRYPT_ROUNDS=10

        LOG_CHANNEL=stack
        LOG_STACK=single
        LOG_DEPRECATIONS_CHANNEL=null
        LOG_LEVEL=error

        DB_CONNECTION=mysql
        DB_HOST=127.0.0.1
        DB_PORT=3306
        DB_DATABASE=rualtech
        DB_USERNAME=root
        DB_PASSWORD=

        SESSION_DRIVER=file
        SESSION_LIFETIME=120
        SESSION_ENCRYPT=false
        SESSION_PATH=/
        SESSION_DOMAIN=null

        BROADCAST_CONNECTION=log
        FILESYSTEM_DISK=local
        QUEUE_CONNECTION=database

        CACHE_STORE=file

        MEMCACHED_HOST=127.0.0.1

        REDIS_CLIENT=phpredis
        REDIS_HOST=127.0.0.1
        REDIS_PASSWORD=null
        REDIS_PORT=6379

        MAIL_MAILER=log
        MAIL_SCHEME=null
        MAIL_HOST=127.0.0.1
        MAIL_PORT=2525
        MAIL_USERNAME=null
        MAIL_PASSWORD=null
        MAIL_FROM_ADDRESS="office@rualtech.ru"
        MAIL_FROM_NAME="ÐÐ»Ñ‚ÐµÑ…"

        AWS_ACCESS_KEY_ID=
        AWS_SECRET_ACCESS_KEY=
        AWS_DEFAULT_REGION=us-east-1
        AWS_BUCKET=
        AWS_USE_PATH_STYLE_ENDPOINT=false

        VITE_APP_NAME="ÐÐ»Ñ‚ÐµÑ…"
        ENVEOF
        fi
        
        echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…:"
        grep "DB_DATABASE" .env
        
        echo "ðŸ§¹ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²ÐµÑÑŒ ÐºÐµÑˆ Laravel..."
        php artisan config:clear
        php artisan cache:clear
        php artisan route:clear
        php artisan view:clear
        php artisan optimize:clear
        
        echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°..."
        chown -R www-data:www-data /var/www/www-root/data/www/rualtech.ru/
        chmod -R 755 /var/www/www-root/data/www/rualtech.ru/
        chmod -R 775 /var/www/www-root/data/www/rualtech.ru/storage/
        chmod -R 775 /var/www/www-root/data/www/rualtech.ru/bootstrap/cache/
        
        echo "âœ… .env Ñ„Ð°Ð¹Ð» Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½!"
        echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
        ls -la .env*
        EOF
        
    - name: Test site response
      run: |
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ ÑÐ°Ð¹Ñ‚Ð°..."
        sleep 5
        
        for i in {1..3}; do
          response=$(curl -s -o /dev/null -w "%{http_code}" https://rualtech.ru/ || echo "error")
          echo "ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° $i: HTTP $response"
          
          if [ "$response" = "200" ]; then
            echo "ðŸŽ‰ Ð¡ÐÐ™Ð¢ Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢!"
            break
          else
            echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° $response, Ð¶Ð´ÐµÐ¼ 10 ÑÐµÐºÑƒÐ½Ð´..."
            sleep 10
          fi
        done
