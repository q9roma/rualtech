name: Fix Production Site

on:
  workflow_dispatch:

jobs:
  fix-prod:
    runs-on: ubuntu-latest
    
    steps:
    - name: Fix production site
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /var/www/www-root/data/www/rualtech.ru/
          
          echo "🔧 Исправляем продакшн сайт..."
          
          # Убеждаемся что .env правильный
          echo "📋 Текущие настройки БД:"
          grep "DB_" .env || echo "Нет настроек БД"
          
          # Создаем правильный .env
          cat > .env << 'ENVEOF'
          APP_NAME=Laravel
          APP_ENV=production
          APP_KEY=base64:koCcDULFl7i77qQI2uVkvcZ2613SXNC8R1mCahDmveU=
          APP_DEBUG=false
          APP_URL=https://rualtech.ru
          
          APP_LOCALE=ru
          APP_FALLBACK_LOCALE=ru
          APP_FAKER_LOCALE=ru_RU
          
          DB_CONNECTION=mysql
          DB_HOST=localhost
          DB_PORT=3306
          DB_DATABASE=rualtech
          DB_USERNAME=alexsor
          DB_PASSWORD=eY7rG4pX7r
          
          SESSION_DRIVER=file
          SESSION_LIFETIME=120
          SESSION_ENCRYPT=false
          SESSION_PATH=/
          SESSION_DOMAIN=null
          
          BROADCAST_CONNECTION=log
          FILESYSTEM_DISK=local
          QUEUE_CONNECTION=database
          
          CACHE_STORE=file
          
          MAIL_MAILER=log
          MAIL_FROM_ADDRESS="office@rualtech.ru"
          MAIL_FROM_NAME="Алтех"
          
          VITE_APP_NAME="Алтех"
          ENVEOF
          
          # Устанавливаем права
          chown www-data:www-data .env
          chmod 644 .env
          
          echo "📋 Новые настройки БД:"
          grep "DB_" .env
          
          # Очищаем кеш
          php artisan config:clear
          php artisan cache:clear
          php artisan view:clear
          php artisan route:clear
          
          # Исправляем права доступа
          chown -R www-data:www-data storage/
          chown -R www-data:www-data bootstrap/cache/
          chmod -R 775 storage/
          chmod -R 775 bootstrap/cache/
          
          echo "✅ Сайт исправлен!"
