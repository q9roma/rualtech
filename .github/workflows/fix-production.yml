name: Fix Production Site

on:
  workflow_dispatch:

jobs:
  fix-prod:
    runs-on: ubuntu-latest
    
    steps:
    - name: Fix production site
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /var/www/www-root/data/www/rualtech.ru/
          
          echo "ðŸ”§ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ ÑÐ°Ð¹Ñ‚..."
          
          # Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ Ñ‡Ñ‚Ð¾ .env Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹
          echo "ðŸ“‹ Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð‘Ð”:"
          grep "DB_" .env || echo "ÐÐµÑ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Ð‘Ð”"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ .env
          cat > .env << 'ENVEOF'
          APP_NAME=Laravel
          APP_ENV=production
          APP_KEY=base64:koCcDULFl7i77qQI2uVkvcZ2613SXNC8R1mCahDmveU=
          APP_DEBUG=false
          APP_URL=https://rualtech.ru
          
          APP_LOCALE=ru
          APP_FALLBACK_LOCALE=ru
          APP_FAKER_LOCALE=ru_RU
          
          DB_CONNECTION=mysql
          DB_HOST=localhost
          DB_PORT=3306
          DB_DATABASE=rualtech
          DB_USERNAME=alexsor
          DB_PASSWORD=eY7rG4pX7r
          
          SESSION_DRIVER=file
          SESSION_LIFETIME=120
          SESSION_ENCRYPT=false
          SESSION_PATH=/
          SESSION_DOMAIN=null
          
          BROADCAST_CONNECTION=log
          FILESYSTEM_DISK=local
          QUEUE_CONNECTION=database
          
          CACHE_STORE=file
          
          MAIL_MAILER=log
          MAIL_FROM_ADDRESS="office@rualtech.ru"
          MAIL_FROM_NAME="ÐÐ»Ñ‚ÐµÑ…"
          
          VITE_APP_NAME="ÐÐ»Ñ‚ÐµÑ…"
          ENVEOF
          
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð°
          chown www-data:www-data .env
          chmod 644 .env
          
          echo "ðŸ“‹ ÐÐ¾Ð²Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð‘Ð”:"
          grep "DB_" .env
          
          # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÐµÑˆ
          php artisan config:clear
          php artisan cache:clear
          php artisan view:clear
          php artisan route:clear
          
          # Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
          chown -R www-data:www-data storage/
          chown -R www-data:www-data bootstrap/cache/
          chmod -R 775 storage/
          chmod -R 775 bootstrap/cache/
          
          echo "âœ… Ð¡Ð°Ð¹Ñ‚ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½!"
