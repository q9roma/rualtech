name: Debug Admin 500 Error

on:
  workflow_dispatch:

jobs:
  debug-admin:
    runs-on: ubuntu-latest
    
    steps:
    - name: Debug Admin Panel 500 Error
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–∫–∏ 500 –≤ –∞–¥–º–∏–Ω–∫–µ..."
          cd /var/www/www-root/data/www/rualtech.ru
          
          echo "üìÇ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫:"
          ls -la
          
          echo ""
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º .env —Ñ–∞–π–ª:"
          head -20 .env 2>/dev/null || echo ".env –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo ""
          echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ Laravel (storage/logs):"
          if [ -d "storage/logs" ]; then
            find storage/logs -name "*.log" -type f -exec tail -20 {} \; 2>/dev/null || echo "–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          else
            echo "–ü–∞–ø–∫–∞ storage/logs –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          fi
          
          echo ""
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:"
          ls -la storage/ 2>/dev/null || echo "storage/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          ls -la bootstrap/cache/ 2>/dev/null || echo "bootstrap/cache/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          
          echo ""
          echo "üßπ –ü–æ–ø—Ä–æ–±—É–µ–º –æ—á–∏—Å—Ç–∏—Ç—å –∫–µ—à–∏:"
          php artisan config:clear 2>&1 || echo "Config clear failed"
          php artisan cache:clear 2>&1 || echo "Cache clear failed"
          php artisan view:clear 2>&1 || echo "View clear failed"
          php artisan route:clear 2>&1 || echo "Route clear failed"
          
          echo ""
          echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î:"
          php artisan tinker --execute="
          try {
            echo 'DB connection: ' . (DB::connection()->getPdo() ? 'OK' : 'FAILED');
          } catch (Exception \$e) {
            echo 'DB Error: ' . \$e->getMessage();
          }
          " 2>&1 || echo "DB test failed"
          
          echo ""
          echo "üéØ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É users:"
          mysql -u alexsor -peY7rG4pX7r -D rualtech -e "
            SELECT COUNT(*) as user_count FROM users;
            SELECT name, email FROM users LIMIT 3;
          " 2>&1 || echo "MySQL query failed"
          
          echo ""
          echo "üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞:"
          nginx -t 2>&1 || echo "Nginx config test failed"
          
          echo ""
          echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã PHP:"
          ps aux | grep php | head -5
          
          echo ""
          echo "üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞:"
          df -h | grep -E "(Filesystem|/var)"
