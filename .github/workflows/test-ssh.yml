name: Test SSH Connection

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: '–¢–∏–ø —Ç–µ—Å—Ç–∞'
        required: false
        default: 'basic'

jobs:
  test-ssh:
    runs-on: ubuntu-latest
    
    steps:
    - name: Test SSH connection
      run: |
        echo "üîë –ü—Ä–æ–≤–µ—Ä—è–µ–º SSH –∫–ª—é—á..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–ª—é—á –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö
        if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
          echo "‚ùå SERVER_SSH_KEY —Å–µ–∫—Ä–µ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
          echo "üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:"
          echo "1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å —Ö–æ—Å—Ç–∏–Ω–≥–∞"
          echo "2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ: ssh-keygen -t rsa -b 4096 -f ~/.ssh/github_key"
          echo "3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ: cat ~/.ssh/github_key.pub >> ~/.ssh/authorized_keys"
          echo "4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ: cat ~/.ssh/github_key"
          echo "5. –î–æ–±–∞–≤—å—Ç–µ –≤ GitHub Secrets –∫–∞–∫ SERVER_SSH_KEY"
          exit 1
        fi
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H rualtech.ru >> ~/.ssh/known_hosts
        
        echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ..."
        
        # –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        if ssh -o ConnectTimeout=10 root@rualtech.ru "echo 'SSH —Ä–∞–±–æ—Ç–∞–µ—Ç!'; hostname; whoami"; then
          echo "‚úÖ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!"
        else
          echo "‚ùå SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å"
          echo "üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
          echo "- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π SSH –∫–ª—é—á –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö"
          echo "- –ö–ª—é—á –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ ~/.ssh/authorized_keys –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
          echo "- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º SSH"
          exit 1
        fi
